#! /bin/bash

set -e

ATLAS_TOKEN=$(echo $ATLAS_TOKEN)
ATLAS_USER=$(echo $ATLAS_USER)
BOX_PATH=$1
VERSION=$(cat VERSION)

create_version() {
    echo creating version on Atlas
    curl -s https://atlas.hashicorp.com/api/v1/box/$ATLAS_USER/lathe/versions \
        -X POST \
        -d version[version]=$VERSION \
        -d access_token=$ATLAS_TOKEN \
    | jq .
}

push_box() {
    echo pushing box to Atlas
    curl https://atlas.hashicorp.com/api/v1/box/$ATLAS_USER/lathe/version/$VERSION/providers \
        -X POST \
        -d provider[name]='virtualbox' \
        -d access_token=$ATLAS_TOKEN \
    | jq .
    UPLOAD_PATH=$(curl https://atlas.hashicorp.com/api/v1/box/$ATLAS_USER/lathe/version/$VERSION/provider/virtualbox/upload\?access_token\=$ATLAS_TOKEN | jq .upload_path)
    UPLOAD_PATH=$(echo $UPLOAD_PATH | sed s/\"//g)
    curl -o x -X PUT --upload-file $BOX_PATH $UPLOAD_PATH
}

release_version() {
    echo releasing version on Atlas
    curl https://atlas.hashicorp.com/api/v1/box/$ATLAS_USER/lathe/version/$VERSION/release \
        -X PUT \
        -d access_token=$ATLAS_TOKEN \
    | jq .
}

update_locally() {
    echo updating box locally
    vagrant box update --box=lathe
}

main() {
    test -e $BOX_PATH
    create_version
    push_box
    release_version
    update_locally
}

main
